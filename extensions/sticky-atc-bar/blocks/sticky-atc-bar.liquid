(() => {
  const TRACK_ENDPOINT = "/apps/bdm-sticky-atc/track";

  function track(event, payload = {}) {
    try {
      fetch(TRACK_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ event, ...payload, ts: Date.now() }),
        keepalive: true,
      });
    } catch (_) {}
  }

  function getVariantIdFallback() {
    // 1️⃣ Theme variant input
    const input =
      document.querySelector('input[name="id"]') ||
      document.querySelector('[name="id"]');

    if (input?.value) return Number(input.value);

    // 2️⃣ URL fallback
    const params = new URLSearchParams(window.location.search);
    if (params.get("variant")) return Number(params.get("variant"));

    return null;
  }

  document.addEventListener("click", async (e) => {
    const btn = e.target.closest("[data-bdm-atc]");
    if (!btn) return;

    e.preventDefault();

    const variantId = getVariantIdFallback();
    if (!variantId) {
      console.warn("[BDM ATC] No variant ID found");
      return;
    }

    const qtyInput = document.querySelector("#bdm-qty");
    const quantity = Math.max(1, Number(qtyInput?.value || 1));

    track("add_to_cart", { variantId, quantity });

    try {
      const res = await fetch("/cart/add.js", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          items: [{ id: variantId, quantity }],
        }),
      });

      if (!res.ok) {
        console.error("[BDM ATC] cart/add failed");
        return;
      }

      track("sticky_atc_success", { variantId, quantity });
    } catch (err) {
      console.error("[BDM ATC] request error", err);
    }
  });

  // page view tracking
  track("page_view");
})();
