(function () {
  const bar = document.getElementById("bdm-sticky-atc");
  if (!bar) return;

  const CONFIG = window.BDM_STICKY_ATC_CONFIG || {};

  const atcButton = document.getElementById("bdm-atc");
  const qtyInput = document.getElementById("bdm-qty");
  const variantSelect = document.getElementById("bdm-variant");

  if (!atcButton) return;

  /* ---------------------------------------------
     Helpers
  --------------------------------------------- */

  function isMobile() {
    return window.matchMedia("(max-width: 768px)").matches;
  }

  function getProductForm() {
    return document.querySelector('form[action*="/cart/add"]');
  }

  function getVariantInput(form) {
    return form.querySelector('input[name="id"], select[name="id"]');
  }

  function getQuantityInput(form) {
    return form.querySelector('input[name="quantity"]');
  }

  function getSellingPlanInput(form) {
    return form.querySelector('input[name="selling_plan"], select[name="selling_plan"]');
  }

  /* ---------------------------------------------
     Respect enable toggles
  --------------------------------------------- */

  if (
    (isMobile() && CONFIG.enableMobile === false) ||
    (!isMobile() && CONFIG.enableDesktop === false)
  ) {
    bar.style.display = "none";
    return;
  }

  /* ---------------------------------------------
     Apply styles (safe)
  --------------------------------------------- */

  if (CONFIG.backgroundColor) bar.style.backgroundColor = CONFIG.backgroundColor;
  if (CONFIG.textColor) bar.style.color = CONFIG.textColor;
  if (CONFIG.buttonColor) atcButton.style.backgroundColor = CONFIG.buttonColor;
  if (CONFIG.buttonText) atcButton.textContent = CONFIG.buttonText;

  /* ---------------------------------------------
     Hide UI controls if disabled
  --------------------------------------------- */

  if (qtyInput && CONFIG.showQuantity === false) {
    qtyInput.style.display = "none";
  }

  if (variantSelect && CONFIG.showVariants === false) {
    variantSelect.style.display = "none";
  }

  /* ---------------------------------------------
     CLICK HANDLER — SUBMIT REAL FORM
  --------------------------------------------- */

  atcButton.addEventListener("click", function (e) {
    e.preventDefault();

    const form = getProductForm();
    if (!form) {
      console.error("[Sticky ATC] No product form found");
      return;
    }

    const variantInput = getVariantInput(form);
    if (!variantInput) {
      console.error("[Sticky ATC] No variant input found");
      return;
    }

    /* Variant */
    if (variantSelect && variantSelect.value) {
      variantInput.value = variantSelect.value;
    }

    /* Quantity */
    if (CONFIG.showQuantity !== false) {
      const formQty = getQuantityInput(form);
      if (formQty && qtyInput && qtyInput.value) {
        formQty.value = qtyInput.value;
      }
    }

    /* Selling plan (subscriptions) */
    if (CONFIG.showSubscription !== false) {
      const sellingPlanFormInput = getSellingPlanInput(form);
      const sellingPlanSticky = document.querySelector(
        '#bdm-sticky-atc select[name="selling_plan"], #bdm-sticky-atc input[name="selling_plan"]'
      );

      if (sellingPlanFormInput && sellingPlanSticky) {
        sellingPlanFormInput.value = sellingPlanSticky.value || "";
      }
    }

    // Fire native submit
    atcButton.disabled = true;
    atcButton.textContent = "Adding…";

    form.dispatchEvent(new Event("submit", { bubbles: true, cancelable: true }));
    form.submit();

    setTimeout(() => {
      atcButton.disabled = false;
      atcButton.textContent = CONFIG.buttonText || "Add to cart";
    }, 1500);
  });

})();
