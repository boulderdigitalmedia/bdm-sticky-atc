(() => {
  const TRACK_ENDPOINT = "/apps/bdm-sticky-atc/track";

  /* ---------------- Analytics ---------------- */

  function getSessionId() {
    const KEY = "bdm_sticky_atc_session_id";
    let id = localStorage.getItem(KEY);
    if (!id) {
      id = crypto.randomUUID();
      localStorage.setItem(KEY, id);
    }
    return id;
  }

  function track(event, payload = {}) {
    try {
      fetch(TRACK_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          event,
          ...payload,
          sessionId: getSessionId(),
          ts: Date.now()
        }),
        keepalive: true
      });
    } catch {}
  }

  /* ---------------- Helpers ---------------- */

  function getVariantId() {
    // Shopify canonical variant input
    const input =
      document.querySelector('input[name="id"]') ||
      document.querySelector('[name="id"]');

    if (input?.value) return Number(input.value);

    // URL fallback
    const params = new URLSearchParams(window.location.search);
    if (params.get("variant")) return Number(params.get("variant"));

    return null;
  }

  function getQuantity() {
    const qty = document.querySelector("#bdm-qty");
    return Math.max(1, Number(qty?.value || 1));
  }

  /* ---------------- Init ---------------- */

  document.addEventListener("click", async (e) => {
    const btn = e.target.closest("[data-bdm-atc]");
    if (!btn) return;

    e.preventDefault();

    const variantId = getVariantId();
    if (!variantId) {
      console.warn("[BDM STICKY ATC] No variant ID found");
      return;
    }

    const quantity = getQuantity();

    track("sticky_atc_click", {
      variantId,
      quantity
    });

    try {
      const res = await fetch("/cart/add.js", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          items: [{ id: variantId, quantity }]
        })
      });

      if (!res.ok) {
        console.error("[BDM STICKY ATC] cart/add failed");
        return;
      }

      track("sticky_atc_success", {
        variantId,
        quantity
      });

      // optional redirect
      window.location.href = "/cart";
    } catch (err) {
      console.error("[BDM STICKY ATC] error", err);
    }
  });

  // impression fires once
  track("sticky_atc_impression");
})();
