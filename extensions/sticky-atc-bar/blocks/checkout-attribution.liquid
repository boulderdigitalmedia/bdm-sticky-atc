{% comment %}
Sticky ATC â€“ Checkout Attribution
Captures checkout token before redirect
{% endcomment %}

<script>
  (function () {
    let sent = false;

    async function resolveCartToken() {
      const liquidToken = "{{ cart.token | escape }}";
      if (liquidToken) return liquidToken;
      const analyticsToken = window.ShopifyAnalytics?.meta?.cartToken;
      if (analyticsToken) return analyticsToken;
      try {
        const res = await fetch("/cart.js", { credentials: "same-origin" });
        if (!res.ok) return null;
        const data = await res.json();
        return data?.token || null;
      } catch (_err) {
        return null;
      }
    }

    async function sendAttribution() {
      try {
        if (sent) return;

        const checkoutToken = window.Shopify?.checkout?.token || null;
        const cartToken = await resolveCartToken();

        if (!checkoutToken && !cartToken) return;

        const payload = {
          shop: "{{ shop.permanent_domain }}",
          checkoutToken,
          cartToken: cartToken || null,
          timestamp: Date.now()
        };

        const url = `https://sticky-add-to-cart-bar-pro.onrender.com/apps/bdm-sticky-atc/checkout?shop=${encodeURIComponent(payload.shop)}`;
        const body = new Blob([JSON.stringify(payload)], {
          type: "application/json"
        });
        if (navigator.sendBeacon) {
          sent = navigator.sendBeacon(url, body);
        }

        if (!sent) {
          sent = true;
          fetch(url, {
            method: "POST",
            body,
            headers: { "Content-Type": "application/json" },
            keepalive: true
          }).catch(() => {});
        }
      } catch (e) {
        console.warn("Sticky ATC attribution error", e);
      }
    }

    document.addEventListener("submit", function (e) {
      if (e.target.action && e.target.action.includes("/checkout")) {
        sendAttribution();
      }
    });

    document.addEventListener("click", function (e) {
      const link = e.target.closest('a[href*="/checkout"]');
      const button =
        e.target.closest('button[name="checkout"]') ||
        e.target.closest('input[name="checkout"]');

      if (link || button) {
        sendAttribution();
      }
    });

    if (window.Shopify?.checkout?.token) {
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", sendAttribution);
      } else {
        sendAttribution();
      }
    }

    document.addEventListener("visibilitychange", function () {
      if (document.visibilityState === "hidden") {
        sendAttribution();
      }
    });

    window.addEventListener("pagehide", sendAttribution);
  })();
</script>

{% schema %}
{
  "name": "Sticky ATC Attribution",
  "target": "body",
  "settings": []
}
{% endschema %}
