{% comment %}
Sticky ATC â€“ Checkout Attribution
Captures checkout token before redirect
{% endcomment %}

<script>
  (function () {
    function sendAttribution() {
      try {
        const checkoutToken = window.Shopify?.checkout?.token || null;
        const cartToken = "{{ cart.token | escape }}";

        if (!checkoutToken && !cartToken) return;

        const payload = {
          shop: "{{ shop.permanent_domain }}",
          checkoutToken,
          cartToken: cartToken || null,
          timestamp: Date.now()
        };

        const url = `https://sticky-add-to-cart-bar-pro.onrender.com/apps/bdm-sticky-atc/checkout?shop=${encodeURIComponent(payload.shop)}`;
        const body = new Blob([JSON.stringify(payload)], {
          type: "application/json"
        });
        navigator.sendBeacon(url, body);
      } catch (e) {
        console.warn("Sticky ATC attribution error", e);
      }
    }

    document.addEventListener("submit", function (e) {
      if (e.target.action && e.target.action.includes("/checkout")) {
        sendAttribution();
      }
    });

    document.addEventListener("click", function (e) {
      const link = e.target.closest('a[href*="/checkout"]');
      const button =
        e.target.closest('button[name="checkout"]') ||
        e.target.closest('input[name="checkout"]');

      if (link || button) {
        sendAttribution();
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Sticky ATC Attribution",
  "target": "body",
  "settings": []
}
{% endschema %}
